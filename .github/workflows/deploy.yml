name: CD - Deployment a ambiente de pruebas

on:
  push:
    branches:
      - main        # solo cuando algo ya estable llega a main
  workflow_dispatch: # permite ejecutarlo a mano desde la pestaña Actions

jobs:
  build-and-unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # STAGE 1: BUILD + UNIT TESTS
      - name: Build + unit tests (mvn test)
        run: mvn -B clean test

  deploy-and-acceptance:
    runs-on: ubuntu-latest
    needs: build-and-unit-tests    # solo corre si el job anterior fue OK

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # STAGE 2: BUILD ARTEFACTO
      - name: Construir artefacto para deploy
        run: mvn -B -DskipTests clean package

      # STAGE 3: DEPLOY A AMBIENTE DE PRUEBAS (GREEN SIMULADO)
      - name: Deploy a ambiente de pruebas (GREEN)
        run: |
          mkdir -p deploy/blue
          mkdir -p deploy/green
          cp target/examen-auto-prueb-0.0.1-SNAPSHOT.jar deploy/green/app.jar
          echo "Versión desplegada en GREEN:"
          ls deploy/green

      # STAGE 4: ACCEPTANCE TESTS (usamos los *IT como smoke/acceptance)
      - name: Ejecutar acceptance tests (CalculatorIT como prueba de aceptación)
        run: mvn -B -Dtest=*IT test

      # STAGE 5: BLUE-GREEN / SWITCH
      - name: Cambiar tráfico a GREEN (simulado)
        if: success()
        run: |
          echo "green" > deploy/current_environment.txt
          echo "Tráfico apuntando a entorno GREEN"
          echo "Contenido de deploy/:"
          ls deploy

      # STAGE 6: ROLLBACK A BLUE SI FALLAN LOS ACCEPTANCE
      - name: Rollback a BLUE (simulado)
        if: failure()
        run: |
          echo "blue" > deploy/current_environment.txt
          echo "Error en tests de aceptación, rollback a BLUE"
          echo "Estado final de deploy/:"
          ls deploy
